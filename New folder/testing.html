<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>Assignment 3</title>
  <script src="//d3js.org/d3.v4.min.js"></script>
  <script src="http://labratrevenge.com/d3-tip/javascripts/d3.tip.v0.6.3.js"></script>  
  <style>
    path {
      fill: none;;
      stroke: #646464;
      stroke-width:1px;
      stroke-dasharray: 2,2;
      stroke-linejoin: round;
    }
  </style>
</head>

<body>
<script>
  var width = 900;
  var height = 900;
  
  var stateName = d3.map(),
  totalAccident = d3.map(),
  nameById = d3.map();
  
  var projection = d3.geoMercator().scale(1).translate([0,0]);
  var path = d3.geoPath().projection(projection);
  var color = d3.scaleQuantize()
  .range(["rgb(247,251,255)",
  "rgb(222,235,247)",
  "rgb(198,219,239)",
  "rgb(158,202,225)",
  "rgb(107,174,214)",
  "rgb(66,146,198)",
  "rgb(33,113,181)",
  "rgb(8,81,156)",
  "rgb(8,48,107)"
  ]);
    //Colors derived from ColorBrewer, by Cynthia Brewer, and included in
    //https://github.com/d3/d3-scale-chromatic
  var svg = d3.select("body")
    .append("svg")
    .attr("width", width)
    .attr("height", height);


  

      d3.csv("data-viz-assg3-data/statistik-mengikut-jenis-kemalangan-dan-kecederaan-2011.csv", function(data) {
      //Load in agriculture data
        //Set input domain for color scale
        color.domain([
          d3.min(data, function(d) { return parseInt(d.JUMLAH_KMLG); }), 
          d3.max(data, function(d) { return parseInt(d.JUMLAH_KMLG); })
        ]);
        console.log("Color Domain=",color.domain())
        //Load in GeoJSON data
        console.log(data)
        d3.json("malaysia_map/malaysia_geo.json", function(json) {
        
          var bounds = path.bounds(json);
          var s = 0.95 / Math.max((bounds[1][0] - bounds[0][0]) / width, (bounds[1][1] - bounds[0][1]) / height);
          var t = [(width - s * (bounds[1][0] + bounds[0][0])) / 2, (height - s * (bounds[1][1] + bounds[0][1])) / 2];

          //Merge the ag. data and GeoJSON
          //Loop through once for each ag. data value
          for (var i = 0; i < data.length; i++) {
        
            //Grab state name
            var dataState = data[i].NEGERI;
            //console.log(data[i].JUMLAH_KMLG)
            //Grab data value, and convert from string to float
            var dataValue = parseInt(data[i].JUMLAH_KMLG);
        
            //Find the corresponding state inside the GeoJSON
            for (var j = 0; j < json.features.length; j++) {
            
              var jsonState = json.features[j].properties.NAME_1;
              
              //console.log("i=",i,dataState,"value=",dataValue,"j=",j,jsonState);
              console.log(dataState,"VS",jsonState);
              if (dataState == jsonState) {
                //Copy the data value into the JSON
                json.features[j].properties.value = dataValue;
                json.features[j].properties.valueMaut = parseInt(data[i].JUMLAH_KMLG_MAUT);
                json.features[j].properties.valueParah = parseInt(data[i].JUMLAH_KMLG_PARAH);
                json.features[j].properties.valueRingan = parseInt(data[i].JUMLAH_KMLG_RINGAN);
                json.features[j].properties.valueRosak = parseInt(data[i].JUMLAH_KMLG_ROSAK_SAHAJA);
                json.features[j].properties.valueKematian = parseInt(data[i].JUMLAH_KEMATIAN);
                json.features[j].properties.valueCederaParah = parseInt(data[i].JUMLAH_CEDERA_PARAH);
                json.features[j].properties.valueCederaRingan = parseInt(data[i].JUMLAH_CEDERA_RINGAN);
                console.log(json.features[j].properties.value,json.features[j].properties.valueMaut,json.features[j].properties.valueParah,json.features[j].properties.valueRingan,json.features[j].properties.valueRosak,json.features[j].properties.valueKematian,json.features[j].properties.valueCederaParah,json.features[j].properties.valueCederaRingan)
;               //console.log("JSON FEATURES=",json.features[j].properties.value)
                
                //Stop looking through the JSON
                break;
                
              }
            }   
          }
              projection
              .scale(s)
              .translate(t);
          //Bind data and create one path per GeoJSON feature
          svg.selectAll("path")
             .data(json.features)
             .enter()
             .append("path")
             .attr("d", path)
             .style("fill", function(d) {
                //Get data value
                var value = d.properties.value;
                if (value) {
                console.log(d.properties.NAME_1,"Jumlah Kemalangan =",value)
                  //If value exists…
                console.log("Color=", color(value));
                  return color(value);
                } else {
                  //If value is undefined…
                  return "#ccc";
                }
             })
             .style("stroke", "black")
             .style("stroke-width", 1)
             .on("mouseover", function(d) {
              var xPosition = d3.mouse(this)[0];
              var yPosition = d3.mouse(this)[1] - 30;

              svg.append("text")
                .attr("id", "tooltip")
                .attr("x", xPosition)
                .attr("y", yPosition)
                .attr("text-anchor", "middle")
                .attr("font-family", "sans-serif")
                .attr("font-size", "15px")
                .attr("font-weight", "bold")
                .attr("fill", "black")
                .attr("text-anchor","start")
                .append("tspan")
                .attr("float","left")
                .attr("x", xPosition-200)
                .attr("y", yPosition)
                .text(d.properties.NAME_1)
                .append("tspan")
                .attr("font-size", "11px")
                .attr("x", xPosition-200)
                .attr("y", yPosition+10)
                .text("Kemalangan: "+d.properties.value)
                .append("tspan")
                .attr("x", xPosition-200)
                .attr("y", yPosition+20)
                .text("Kemalangan Maut: "+d.properties.valueMaut)
                .append("tspan")
                .attr("x", xPosition-200)
                .attr("y", yPosition+30)
                .text("Kemalangan Parah: "+d.properties.valueParah)
                .append("tspan")
                .attr("x", xPosition-200)
                .attr("y", yPosition+40)
                .text("Kemalangan Ringan: "+d.properties.valueRingan)
                .append("tspan")
                .attr("x", xPosition-200)
                .attr("y", yPosition+50)
                .text("Kemalangan Rosak Sahaja: "+d.properties.valueRosak)
                .append("tspan")
                .attr("x", xPosition-200)
                .attr("y", yPosition+60)
                .text("Kemalangan Kematian: "+d.properties.valueKematian)
                .append("tspan")
                .attr("x", xPosition-200)
                .attr("y", yPosition+70)
                .text("Kemalangan Cedera Parah: "+d.properties.valueCederaParah)
                .append("tspan")
                .attr("x", xPosition-200)
                .attr("y", yPosition+80)
                .text("Kemalangan Cedera Ringan: "+d.properties.valueCederaRingan);
                
                d3.select(this)
                .style("fill", "#feb24c");
              })
            .on("mouseout", function(d) {
              d3.select("#tooltip").remove();

              d3.select(this)
              .transition()
              .duration(250)
              .style("fill", function(d) {
                var value = d.properties.value;

                if (value) {
                  return color(value);
                } else {
                  return "#ccc";
                }
              })
            });
               
          svg.selectAll("circle")
           .data(data)
           .enter()
           .append("circle")
           .attr("cx", function(d) {
            return projection([d.LONGTITUDE, d.LATITUDE])[0];
            })
           .attr("cy", function(d) {
            return projection([d.LONGTITUDE, d.LATITUDE])[1];
            })
           console.log('imhere1');
           .attr("r", function(d) {
            console.log('imhere');
            return Math.sqrt(parseInt(d.JUMLAH_KMLG) * 0.007);
            })
           console.log('imhere3');
           .style("fill", "yellow")
           .style("stroke", "gray")
           .style("stroke-width", 0.25)
           .style("opacity", 0.5)   
            .on("mouseover", function(d) {
              var xPosition = d3.mouse(this)[0];
              var yPosition = d3.mouse(this)[1] - 30;

              svg.append("text")
                .attr("id", "tooltip")
                .attr("x", xPosition)
                .attr("y", yPosition)
                .attr("text-anchor", "middle")
                .attr("font-family", "sans-serif")
                .attr("font-size", "11px")
                .attr("font-weight", "bold")
                .attr("fill", "black")
                .append("tspan")
                .attr("x", xPosition)
                .attr("y", yPosition)
                .text(d.NEGERI)
                .append("tspan")
                .attr("x", xPosition)
                .attr("y", yPosition+10)
                .text("Jumlah Kemalangan: "+d.JUMLAH_KMLG);
                
                
                d3.select(this)
                .style("fill", "#feb24c");
              })
            .on("mouseout", function(d) {
              d3.select("#tooltip").remove();

              d3.select(this)
              .transition()
              .duration(250)
              .style("fill", "yellow")
              .style("stroke", "gray")
              .style("stroke-width", 0.25)
              .style("opacity", 0.5)    
            }); 
      
      
        });
      
      });
      
    </script>
  </body>
</html>